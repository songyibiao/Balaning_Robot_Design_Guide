---
typora-root-url: ./
---

# 烧录程序指南

> * *本小节教你如何使用 Micro-USB 和 Jlink-ob 烧录程序代码到小车里去。* 
> * *自2019年1月1日起购买「小霸王Lite」的小伙伴，可参照本节方法烧录代码。*

**如果是在 2020年 08月 01日前购买的套件，请参考旧版烧录程序指南。**

自 2020年 08月 01日起，两轮自平衡小车「小霸王Lite」的 STM32 核心板升级添加了一键下载电路，同样的是适用 Micro-USB 数据线进行下载，**与旧核心板相比，不同之处是不再需要反复设置 BOOT0 跳帽去配置电平高低，**只需要配置好 MCUISP 软件就可以实现一键下载，一劳永逸。下面会对下载过程进行详细说明。

**提示：建议用户认真阅读本节的每一行文字。**

我们可以通过以下 2 种烧录（下载）方式，将程序代码烧录到两轮自平衡小车中：

1. **使用 Micro-USB 数据线烧录程序。Micro-USB 数据线是套件标配的。**
2. 使用 SWD 烧录工具（JLink-ob、ST-Link 等）烧录程序。这些工具的使用喜好因人而异，套件并不配备，用户需要另行购买。

## 1.0 使用 Micro-USB 数据线烧录

### 1.1 硬件准备

* 两轮自平衡小车「小霸王Lite」
* Micro-USB 数据线
* 电脑

### 1.2 软件工具

* mcuisp.exe 烧录软件（资料包路径：/07、开发工具安装包/mcuisp.exe）
* CH340C USB to UART 芯片驱动（资料包路径：/07、开发工具安装包/CH340驱动/CH341SER.EXE）

### 1.3 操作步骤

> *本示例中使用 Windows 7 系统，如果你使用的是其他版本的系统，如 Windows 8、Windows 10，都可以使用该驱动。该驱动支持 32、64位 Windows 10 8.1 8 7 VISTA XP。*

#### 1.3.1 预安装 CH340 驱动

在资料包中找到 CH340 的驱动（资料包路径：/07、开发工具安装包/CH340驱动/CH341SER.EXE） ，直接双击运行进行安装。双击后会显示以下提示运行窗口，点击“运行”。

![提示运行窗口 alt ><](/img/2020-07-23_173520.png)

接着，会出现驱动安装界面，如下图所示。我们点击“安装”。

![驱动安装界面 alt ><](/img/2020-07-23_173552.png)

驱动会自动安装完成。然后提示“驱动预安装成功”。

![驱动预安装成功 alt ><](/img/2020-07-23_173909.png)

这就完成了驱动的预安装。但我们需要在实际使用中检验驱动是否真的安装成功。

#### 1.3.2 检验驱动安装

使用 Micro-USB 数据线连接电脑和小车，在电脑桌面上左键点击「我的电脑」，右键点击「属性」，再在面板上点击「设备管理器」，在 「端口（COM和LPT）」 中可以找到分配的 COM 口。如果显示 COM 口，则表示驱动程序已经正常安装。示例截图为 COM4。

![](/img/2020-07-23_174524.png)

#### 1.3.3 使用 mcuisp.exe 烧录

在资料包中找到 mcuisp.exe 烧录软件（资料包路径：/07、开发工具安装包/mcuisp.exe） ，双击运行该软件。如果你是第一次使用该软件，此时可以看到该软件的默认界面设置，如下图所示：

![mcuisp.exe 默认界面设置 alt ><](/img/2019-01-05_235555.png)

我们要对 mcuisp.exe 烧录软件进行简单的设置，以实现一键下载。所谓一键下载，就是插上数据线后，只需要点击 “开始编程(P)” 按钮就可以实现下载，再也不用对 BOOT0 进行设置。具体的设置，主要就是设置成“DTR低电平复位，RTS高电平进Bootloader，如下图所示。Port 口要选择我们使用的 COM 口，在这里我们是分配到了 COM4，所以选择 COM4。bps 即波特率，我们常用 115200，波特率越高，下载速度越快。在实际测试中，我们将波特率设置成最高的 460800 都可以稳定下载。至于烧录 hex 代码文件，我们在这里是选择了小车的出厂代码，资料包里有该代码，资料包路径：/02.源代码/Mwbalanced-stm32-小霸王Lite-firmware-互补滤波-none V3.3/Output/BasicBalance.hex。

![mcuisp.exe 一键下载设置 alt ><](/img/2020-07-23_175502.png)

**点击 mcuisp.exe 软件的「开始编程(P)」 按钮**，就会自动开始烧录代码。如下图所示。

![自动烧录代码中 alt ><](/img/2020-07-23_180246.png)

代码烧录完毕。提示「命令执行完毕，一切正常」。如下图所示。

![](/img/2020-07-23_180313.png)



## 2.0 使用 JLink-ob 烧录代码

### 2.1 硬件准备

* 两轮自平衡小车「小霸王Lite」
* JLink-ob 
* 电脑

### 2.2 软件工具

* MDK-ARM 5.17

> *使用 JLink-ob 下载需要先安装好 MDK-ARM 软件。*

### 2.3 操作步骤

使用 Jlink-ob 烧录时，对应 JLink-ob 和 STM32 控制板上的接口丝印，并将 JLink-ob 的 SWD 四线插到 STM32 控制板的 SWD 排针上。 

![](/img/JLINK-OB下载.jpg "")

然后，点击 MDK-ARM 左上角快捷工具栏中的 `Load` 按钮（或者选项菜单中选择`Flash-Download`），就可以把编译好的代码程序烧录到芯片中去。

![MDK界面](/img/001MDK截图界面2.png "")

烧录成功之后，会在 MDK-ARM 下方的`Build Output`框中出现一段提示。

![MDK界面](/img/001MDK截图界面3.png "")

至此，烧录已经成功，程序一般会自动运行。JLink-ob 提供的电流不足以驱动电机转动，我们把电池装好，开机上电，就能看到代码在小车里的运行情况啦。如果你发现程序没有运行，那是很大可能是因为我们在设置中没有选上自动运行，这时需要手动复位，按一下控制板上的复位按键或者重新上电，程序就会运行。如果觉得每次手动复位太麻烦，我们还可以设置一下，在 MDK-ARM 开发环境中点击 **`Target Options…->Debug->Setting->Flash DownLoad`**，把 `Reset and Run` 选项打勾选上，烧录完代码就会自动复位并运行程序。

![MDK界面](/img/001MDK截图界面4.png)

如果在下载时出错，提示检测不到 JTAG，那是因为 JLink-ob 使用的是 SWD，这时要依次点击**`Target Options…->Debug->Setting->J-Link/J-Trace Adapter`**，在 `ort` 选择栏将默认的 `JTA` 更改选择 `SW` 。

![MDK界面](/img/001MDK截图界面5.png)

选择烧录工具为 `JLINK/J-TRACE Cortex`。

![MDK界面](/img/001MDK截图界面6.png)

 将 `JTAG` 更改选择 `SW` 。


资料包里的程序工程默认的 SWD 烧录器是设置为 JLink，所以，我们能直接使用 JLink-ob 烧录代码，如果想使用ST-Link ，那么需要在 `Target Options…->Debug` 将 `JLINK/J-TRACE Cortex` 改成 `ST-Link Debugger` 或其他。

![](/img/2019-01-06_143240.png)
